# 생성형 모델

의도 분류, 추천 도서 평가, 도서 추천 사유 생성에 사용되는 생성형 모델에 관한 문서.

## Requirements
`Python 3.8.13` : 실험을 진행한 환경의 파이썬 버전.

`Python 3.10` 이상 버전의 경우 Google Colab에서 실행해보았을 때는 문제가 없었음. 다만 확실하지 않음

Packages
- `Pytorch 1.13.0+cu117` : 학습 데이터 로드 및 모델 학습을 위한 기능 지원
- `transformers 4.30.0` : Huggingface에서 오픈소스 LLM을 불러오기 및 fine-tuning
- `accelerate` : transformers에서 학습 시 요구
- `bitsandbytes` : 양자화된 모델 사용 및 모델에 양자화를 적용
- `peft`: LoRA 기법 적용

## Installation
```
pip install torch==1.13.0
pip install transformers==4.30.0
pip install -U accelerate
pip install bitsandbytes
pip install peft
```

### 주의 사항
`Pytorch`와 `transformers`의 버전은 반드시 위 버전을 따라야 함

## Model Fine-tuning
`./training_model` 파일 내에 위치

- `book_evaluation_generation.py` : 추천 도서 평가 모델 학습 코드
- `book_recommendation_train.py` : 도서 추천 사유 생성 학습 코드
- `intention_train.py` : 의도 분류 학습 코드
- `consolidated_model_train.py` : 3가지 task 통합 모델

## Prompt
각 모델의 역할을 명시하는 글. 학습 데이터 앞에 붙여서 생성

각 task별 prompt :
```
PROMPT_DICT ={
    "intention": (
        "이 모델은 '입력 문장'을 분석해서 의도를 분류하는 모델입니다. "
        "분류할 의도로는 [메타 정보 검색], [키워드 검색], [유사도서 검색], [판매량 검색], 그리고 [그 외]가 있습니다. "
        "입력 문장이 책 추천과 관련이 없는 경우 [그 외]로 분류합니다. "
        "입력 문장이 책 추천과 관련이 있는 경우, 다음과 같이 분류합니다. "
        "저자, 출판사, 기간 등 메타 정보가 단서에 포함된 경우 [메타 정보 검색]으로 분류합니다. "
        "키워드 정보만 단서에 포함된 경우 [키워드 검색]으로 분류합니다. "
        "제목 정보가 단서에 포함된 경우 예외 없이 [유사도서 검색]으로 분류합니다. "
        "판매량 정보가 단서에 들어간 경우 예외 없이 [판매량 검색]으로 분류합니다. "
        "우선, 입력 데이터를 받으면 주어진 입력 데이터에서 의도를 분류할 때 도움이 될 수 있는 단서들을 추출합니다. "
        "그리고 각 단서마다 어떤 종류의 단서인지 표시합니다. "
        "그 다음, 주어진 입력 데이터와 단서들을 바탕으로 어떤 의도인지 추론하는 글을 생성합니다. "
        "그 후, 입력 데이터와 단서들과 추론한 글을 바탕으로 주어진 5가지 의도 중 하나를 생성합니다. [의도: ]를 적고 생성합니다. "
        "반드시 [단서들], [추론], [의도] 순서대로 생성해야 합니다. "
        "의도를 생성할 때 반드시 주어진 글자들과 동일하게 생성해야 합니다.\n"
        "입력: {input}\n\n"
    ),
    "evaluation": (
        "EVALUATION: 주어진 사용자의 질문과 정보를 바탕으로 한 책 추천의 적절성을 평가해 주세요. "
        "만약 추천된 책이 사용자의 QUERY과 관련되어 있고 INFO에 잘 부합한다면 'Pass'을, 그렇지 않다면 'Fail'을 부여하세요. "
        "책의 주제, 사용자 질문과의 관련성, 그리고 사용자의 필요에 대한 적합성을 고려하세요. "
        "추천이 적절하고 관련이 있는지 평가하는 것이 중요합니다.\n{input}\n\n"
    ),
    "introduction": (
        "### Prompt(명령):\nresponse_to_user: {{input에 주어진 사용자 질의에 응답하는 문구를 생성해줘}}\n\n### Input(입력):{input}\n\n### Response(응답):"
    ),
    "generation": (
        "### Prompt(명령):\nbook_recommendation: {{input에 주어진 책 정보와 사용자 질의를 바탕으로 그 책을 추천한 사유를 생성해줘}}\n\n
        ### Input(입력):{input}\n\n### Response(응답):"
    ),
}
```

- `PROMPT_DICT["intention"]` : 의도 분류 prompt
- `PROMPT_DICT["evaluation"]` : 추천 도서 평가 prompt
- `PROMPT_DICT["introduction"]` : 추천 멘트 생성 prompt
- `PROMPT_DICT["generation"]` : 추천 사유 생성 prompt

각 prompt의 끝에 `{input}`에 입력 문장이 들어간다.

## Data Format For Training

데이터는 모두 JSON 형식으로 저장되어야 한다.

1. 의도 분류 모델
```
{
  "input": "입력 문장",
  "clues": "[단서들 ...]",
  "reasoning": "추론 문장",
  "intention": "의도"
}
```

- 입력 문장에는 사용자의 질의가 들어간다
- 단서는 대괄호 `"[]"` 안에 명시한다 (대괄호 옆에 따옴표도 반드시 표기). 입력 문장에서 단서로 쓰일만한 단어 또는 문구를 적고 바로 옆에 띄어쓰기 없이 `:` 을 적은 후, 해당 단서의 유형을 명시해준다.
  학습 데이터에 포함되어 있는 유형들은 다음과 같다:
  
  |유형|설명|예시|
  |---|---|---|
  |저자|책의 저자 정보|이원복:저자, 애거서 크리스티:저자|
  |출판사|책의 출판사 정보|민음사:출판사, 애플북스:출판사|
  |기간|책의 출판 시기와 연관된 정보|올해:기간, 3개월동안:기간|
  |제목|책의 제목|나의 라임 오랜지 나무:제목, 삼국지:제목|
  |판매량|판매량 정보가 필요한 정보|베스트셀러:판매량, 인기도서:판매량|
  |키워드|그 외 책 추천에 도움이 될만한 내용|초급 한국어:키워드, 학습:키워드|

  이외에도 필요에 따라 유형을 세부적으로 추가하는 것도 가능하다. 다만 추가할 경우 관련 유형을 담은 데이터를 많이 추가해줘야 한다.
- 추론
- 의도는 5가지로 분류된다

  |의도|설명|
  |---|---|
  |메타 정보 검색|저자, 출판사, 출판 시기 등 도서의 메타 정보가 단서에 포함된 경우|
  |유사도서 검색|책 제목이 포함된 경우, 다른 유형의 단서들이 있더라도 유사도서 검색으로 분류|
  |판매량 검색|판매량 관련 단서가 포함된 경우, 위와 동일하다. 다만 책 제목과 충돌 시 유서도서 검색을 우선시한다|
  |키워드 검색|위 3가지 유형을 제외한 책 추천 관련 입력 문장|
  |그 외|책 추천과 관련이 없는 경우|

예시 데이터
```
{
        "input": "조지 오웰이 쓴 사회 비판적인 내용을 담은 책을 추천받고 싶어.",
        "clues": "[조지 오웰:저자, 사회 비판적인 내용:키워드]",
        "reasoning": "입력 문장은 책 추천을 원하고 있습니다. 이는 '책을 추천받고 싶어'를 통해서 확인할 수 있습니다. 단서를 보면, 저자가 '조지 오웰'인, '사회 비판적인 내용'을 키워드로 하는 책을 원하고 있습니다. 따라서 입력 문장의 의도는 '메타 정보 검색'입니다.",
        "intention": "메타 정보 검색"
}
```
2. 추천 도서 평가 모델
   
3. 책 추천 멘트 및 사유 생성 모델
